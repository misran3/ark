# VTC (Visa Transaction Controls) Configuration
# Copy this to infrastructure/.env and update values as needed

# Visa API Credentials (Sandbox)
VTC_API_KEY=F9ZNQD7PJ5GKEO59K38Q21wGYQNCvqLPxGXE12eyLHIoprCw0
VTC_SHARED_SECRET=gp+FtNKV5n4TZe3Y{0HCeSVaFh2RL9UE/}}H9/d7

# Enrolled Card (Generated from enrollment - see below)
VTC_DOC_ID=ctc-vd-2e30a899-8f02-47c7-89e5-1cee8265b509
VTC_USER_ID=b2d1b9cc-fc3f-4a37-b431-ebf04f20a3e9

# Enforcement Toggle (set to 'true' to enable automatic rule enforcement)
VTC_ENFORCEMENT_ENABLED=false

# Data Source (use 'mock' for testing, 'nessie' for Capital One API)
DATA_SOURCE=mock

# Nessie API Key (if using real data)
# NESSIE_API_KEY=your-nessie-key

# ============================================================================
# ENROLLMENT DETAILS
# ============================================================================
#
# Card Details:
#   PAN: 4514170000000001 (Visa Sandbox Test Card)
#   Name: Alex Miller
#   Email: alexmiller@example.com
#   Country: USA
#
# Enrollment Date: 2026-02-07
# Enrollment Method: core/scripts/visa/pipelines/02_enroll.py
#
# ============================================================================
# DEPLOYMENT INSTRUCTIONS
# ============================================================================
#
# 1. Copy this file to infrastructure/.env:
#    cp .env.vtc.example infrastructure/.env
#
# 2. Deploy the infrastructure:
#    cd infrastructure
#    bun install
#    bunx cdk deploy --all
#
# 3. Test with enforcement DISABLED first:
#    - Verify the API endpoints work
#    - Check that analysis runs without errors
#    - Inspect the vtc_enforcement field in response
#
# 4. Enable enforcement when ready:
#    - Update Lambda environment variable: VTC_ENFORCEMENT_ENABLED=true
#    - Monitor CloudWatch logs for enforcement actions
#    - Test with dry_run=true first if needed
#
# ============================================================================
# TESTING VTC RULES
# ============================================================================
#
# Test GET rules endpoint:
#   curl -X GET \
#     "https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/api/visa/rules/ctc-vd-2e30a899-8f02-47c7-89e5-1cee8265b509" \
#     -H "Authorization: Bearer $COGNITO_TOKEN"
#
# Test PUT rules endpoint (manual rule update):
#   curl -X PUT \
#     "https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/api/visa/rules/ctc-vd-2e30a899-8f02-47c7-89e5-1cee8265b509" \
#     -H "Authorization: Bearer $COGNITO_TOKEN" \
#     -H "Content-Type: application/json" \
#     -d '{
#       "globalControls": [{
#         "isControlEnabled": true,
#         "shouldDeclineAll": false,
#         "declineThreshold": 100,
#         "alertThreshold": 50,
#         "shouldAlertOnDecline": true,
#         "userIdentifier": "b2d1b9cc-fc3f-4a37-b431-ebf04f20a3e9"
#       }]
#     }'
#
# Run complete analysis (includes VTC enforcement if enabled):
#   curl -X GET \
#     "https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/api/captain/complete-analysis" \
#     -H "Authorization: Bearer $COGNITO_TOKEN"
#
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# If VTC API calls fail with 401/403:
#   - Verify API_KEY and SHARED_SECRET are correct
#   - Check CloudWatch logs for signing details
#   - The signing uses lowercase 'apikey' (not 'apiKey')
#
# If enforcement is not running:
#   - Check VTC_ENFORCEMENT_ENABLED=true is set
#   - Verify captain-lambda has database permissions
#   - Check CloudWatch logs for "VTC enforcement" messages
#
# If rules don't apply:
#   - Verify DOC_ID matches the enrolled card
#   - Check USER_ID matches the enrollment userIdentifier
#   - Test with dry_run=true first to see assembled rules
#

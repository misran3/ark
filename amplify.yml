version: 1
applications:
  - appRoot: web
    frontend:
      phases:
        preBuild:
          commands:
            # Install bun
            - curl -fsSL https://bun.sh/install | bash
            - export BUN_INSTALL="$HOME/.bun"
            - export PATH="$BUN_INSTALL/bin:$PATH"
            # Fetch env vars from SSM Parameter Store
            - export NEXT_PUBLIC_USER_POOL_ID=$(aws ssm get-parameter --name "/snatched/user-pool-id" --query "Parameter.Value" --output text)
            - export NEXT_PUBLIC_USER_POOL_CLIENT_ID=$(aws ssm get-parameter --name "/snatched/user-pool-client-id" --query "Parameter.Value" --output text)
            - export NEXT_PUBLIC_API_BASE_URL=$(aws ssm get-parameter --name "/snatched/api-url" --query "Parameter.Value" --output text)
            # Install dependencies
            - bun install --frozen-lockfile
        build:
          commands:
            - export BUN_INSTALL="$HOME/.bun"
            - export PATH="$BUN_INSTALL/bin:$PATH"
            # Re-fetch env vars (each phase runs in isolation)
            - export NEXT_PUBLIC_USER_POOL_ID=$(aws ssm get-parameter --name "/snatched/user-pool-id" --query "Parameter.Value" --output text)
            - export NEXT_PUBLIC_USER_POOL_CLIENT_ID=$(aws ssm get-parameter --name "/snatched/user-pool-client-id" --query "Parameter.Value" --output text)
            - export NEXT_PUBLIC_API_BASE_URL=$(aws ssm get-parameter --name "/snatched/api-url" --query "Parameter.Value" --output text)
            - bun run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
          - ~/.bun/**/*
